<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>给原生小程序安排上Composition API | Lay</title>
    <meta name="generator" content="VuePress 1.5.1">
    
    <meta name="description" content="lay的博客">
    <link rel="preload" href="/blog/assets/css/0.styles.d6b61f4e.css" as="style"><link rel="preload" href="/blog/assets/js/app.7cea3245.js" as="script"><link rel="preload" href="/blog/assets/js/3.98e048c5.js" as="script"><link rel="preload" href="/blog/assets/js/23.b9d9914e.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.a52c8a46.js"><link rel="prefetch" href="/blog/assets/js/11.96b93386.js"><link rel="prefetch" href="/blog/assets/js/12.464bec04.js"><link rel="prefetch" href="/blog/assets/js/13.205ace5f.js"><link rel="prefetch" href="/blog/assets/js/14.7ba6e259.js"><link rel="prefetch" href="/blog/assets/js/15.3309a4ff.js"><link rel="prefetch" href="/blog/assets/js/16.24f7b7fb.js"><link rel="prefetch" href="/blog/assets/js/17.3fee9ae4.js"><link rel="prefetch" href="/blog/assets/js/18.6606ce81.js"><link rel="prefetch" href="/blog/assets/js/19.610c9365.js"><link rel="prefetch" href="/blog/assets/js/20.d14c6cfe.js"><link rel="prefetch" href="/blog/assets/js/21.f5b730da.js"><link rel="prefetch" href="/blog/assets/js/22.91ee4559.js"><link rel="prefetch" href="/blog/assets/js/24.7302aa4b.js"><link rel="prefetch" href="/blog/assets/js/25.14baf63c.js"><link rel="prefetch" href="/blog/assets/js/26.5bdc849d.js"><link rel="prefetch" href="/blog/assets/js/27.18df0574.js"><link rel="prefetch" href="/blog/assets/js/28.d8733c2b.js"><link rel="prefetch" href="/blog/assets/js/29.cde8d1cc.js"><link rel="prefetch" href="/blog/assets/js/30.bf2a57ab.js"><link rel="prefetch" href="/blog/assets/js/4.858d17a4.js"><link rel="prefetch" href="/blog/assets/js/5.80ce1f89.js"><link rel="prefetch" href="/blog/assets/js/6.f9abd419.js"><link rel="prefetch" href="/blog/assets/js/7.87c62cf2.js"><link rel="prefetch" href="/blog/assets/js/8.828d5f15.js"><link rel="prefetch" href="/blog/assets/js/9.c47a04a3.js"><link rel="prefetch" href="/blog/assets/js/vendors~flowchart.1cd746f1.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.d6b61f4e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Lay</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/technology/BE/Java 笔记.html" class="nav-link">
  技术分享
</a></div><div class="nav-item"><a href="/blog/practice/Blog/vuepress.html" class="nav-link">
  实战分享
</a></div><div class="nav-item"><a href="/blog/notes/Mac/Karabiner-Elements.html" class="nav-link">
  烂笔头
</a></div> <a href="https://github.com/lei4519/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/technology/BE/Java 笔记.html" class="nav-link">
  技术分享
</a></div><div class="nav-item"><a href="/blog/practice/Blog/vuepress.html" class="nav-link">
  实战分享
</a></div><div class="nav-item"><a href="/blog/notes/Mac/Karabiner-Elements.html" class="nav-link">
  烂笔头
</a></div> <a href="https://github.com/lei4519/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>BE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Chrome</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Electron</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MiniProgram</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/technology/MiniProgram/framework.html" aria-current="page" class="active sidebar-link">给原生小程序安排上Composition API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/technology/MiniProgram/framework.html#使用示例" class="sidebar-link">使用示例</a></li><li class="sidebar-sub-header"><a href="/blog/technology/MiniProgram/framework.html#原理简述" class="sidebar-link">原理简述</a></li></ul></li><li><a href="/blog/technology/MiniProgram/framework-theory.html" class="sidebar-link">小程序框架原理总结</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="给原生小程序安排上composition-api"><a href="#给原生小程序安排上composition-api" class="header-anchor">#</a> 给原生小程序安排上Composition API</h1> <blockquote><p>通过对逻辑层的封装，让原生小程序使用Vue3的Composotion API</p></blockquote> <h2 id="使用示例"><a href="#使用示例" class="header-anchor">#</a> 使用示例</h2> <p>index.wxml</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>{{count}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>add<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>数字 +1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Epage<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> onShowHooks<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'enhance-weapp'</span>

<span class="token keyword">function</span> <span class="token function">useCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">.</span>value<span class="token operator">++</span>
  <span class="token punctuation">}</span>
  <span class="token function">onShowHooks</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是useCount'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">,</span>
    add
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token function">Epage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onShowHooks</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是setup'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">useCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="原理简述"><a href="#原理简述" class="header-anchor">#</a> 原理简述</h2> <p>流程图先走一波</p> <p><img src="https://gitee.com/lei451927/picture/raw/master/2020-12-28/1609148257431-image.png" alt="image"></p> <ol><li>Epage函数会对传入的<code>options</code>对象属性进行遍历，对所有的生命周期方法进行装饰，将生命周期改造成数组结构，并提供相关的hooks方式以调用注册。</li> <li>在onLoad/created中检查并执行<code>setup</code>函数，拿到其返回值<code>setupData</code>。</li> <li>创建<code>options.data</code>对象副本（如果有的话），使用<code>reactive</code>将其响应式后保存到<code>this.data$</code>属性上。</li> <li>遍历<code>setupData</code>，将其值直接赋值给<code>this.data$</code>，响应式解包赋值给<code>this.data</code>。</li> <li>调用<code>this.setData(this.data)</code>，同步数据至渲染层。</li> <li>保存<code>this.data</code>副本至<code>this.__oldData__</code>。</li> <li>使用<code>watch</code>监听<code>this.data$</code>，响应式触发后diff <code>this.data$</code>与<code>this.__oldData__</code>。</li> <li>调用<code>this.setData(diffData)</code>，同步数据至渲染层。</li> <li>优化部分：当页面onHide时会取消响应式监听，onShow时会重新监听并diff一次数据。</li></ol> <p>以上是核心的实现思路，除此之外还有全局<code>mixins</code>、生命周期阻塞执行、全局生命周期控制等逻辑，具体可以去<a href="https://github.com/lei4519/enhance-weapp" target="_blank" rel="noopener noreferrer">enhance-weapp<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，看下介绍和源码。</p> <p>如果本篇内容对你有帮助，欢迎点赞star👍。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lei4519/blog/edit/master/src/technology/MiniProgram/framework.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">7 个月前</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/technology/HTTP/http2.html" class="prev">
        HTTP 2
      </a></span> <span class="next"><a href="/blog/technology/MiniProgram/framework-theory.html">
        小程序框架原理总结
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.7cea3245.js" defer></script><script src="/blog/assets/js/3.98e048c5.js" defer></script><script src="/blog/assets/js/23.b9d9914e.js" defer></script>
  </body>
</html>
